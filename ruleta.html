<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>SICCHA Streaming | Ruleta</title>

  <style>
    :root{
      --bg:#070707; --panel:rgba(20,20,20,.85); --border:rgba(255,255,255,.10);
      --red:#e50914; --muted:#b3b3b3; --shadow:0 18px 60px rgba(0,0,0,.55);
      --green:#22c55e;
    }
    *{box-sizing:border-box}
    html, body{
      margin:0;
      padding:0;
      height: 100%;
      min-height: 100vh;
    }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      color:#fff;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(229,9,20,.28), transparent 55%),
        radial-gradient(900px 500px at 85% 0%, rgba(34,197,94,.15), transparent 55%),
        linear-gradient(180deg, #0a0a0a, #141414 40%, #0a0a0a);
      overflow-x:hidden;
      position: relative;
      display: flex;
      flex-direction: column;
    }

    /* Luces navide√±as */
    .christmas-lights {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 40px;
      z-index: 100;
      pointer-events: none;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0 20px;
    }
    .light {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: blink 2s infinite;
    }
    .light:nth-child(odd) {
      background: #e50914;
      box-shadow: 0 0 12px #e50914, 0 0 25px rgba(229,9,20,0.5);
    }
    .light:nth-child(even) {
      background: #22c55e;
      box-shadow: 0 0 12px #22c55e, 0 0 25px rgba(34,197,94,0.5);
      animation-delay: 1s;
    }
    .light:nth-child(3n) {
      background: #fbbf24;
      box-shadow: 0 0 12px #fbbf24, 0 0 25px rgba(251,191,36,0.5);
      animation-delay: 0.5s;
    }
    @keyframes blink {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.3; transform: scale(0.8); }
    }

    /* Copos de nieve mejorados */
    .snow{
      pointer-events:none; position:fixed; inset:0; z-index:0;
      background-image:
        radial-gradient(3px 3px at 20px 30px, rgba(255,255,255,.9), transparent),
        radial-gradient(2px 2px at 120px 80px, rgba(255,255,255,.8), transparent),
        radial-gradient(2px 2px at 60px 140px, rgba(255,255,255,.9), transparent),
        radial-gradient(1px 1px at 180px 200px, rgba(255,255,255,.7), transparent),
        radial-gradient(3px 3px at 240px 120px, rgba(255,255,255,.85), transparent),
        radial-gradient(2px 2px at 40px 240px, rgba(255,255,255,.75), transparent);
      background-size: 280px 280px, 240px 240px, 260px 260px, 300px 300px, 220px 220px, 290px 290px;
      animation: snowMove 12s linear infinite;
      opacity:.4;
    }
    @keyframes snowMove{
      from{background-position: 0 -50px, 20px -30px, 40px -60px, 60px -40px, 80px -55px, 100px -45px;}
      to{background-position: 0 50px, 20px 30px, 40px 60px, 60px 40px, 80px 55px, 100px 45px;}
    }

    /* Copos flotantes */
    .snowflake {
      position: fixed;
      top: -10px;
      z-index: 1;
      user-select: none;
      cursor: default;
      animation: fall linear infinite;
      color: rgba(255,255,255,0.8);
      text-shadow: 0 0 8px rgba(255,255,255,0.8);
    }
    @keyframes fall {
      to { transform: translateY(105vh) rotate(360deg); }
    }

    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(12px) saturate(180%);
      background: linear-gradient(180deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.6) 100%);
      border-bottom: 1px solid rgba(229,9,20,.2);
      box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    }
    .topbar{
      max-width:1200px; margin:0 auto; padding:18px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.5px;
      font-size: 20px;
      transition: transform 0.3s ease;
    }
    .brand:hover{transform: scale(1.05);}
    .brand .dot{
      width:12px;height:12px;border-radius:999px;background:var(--red);
      box-shadow:0 0 20px rgba(229,9,20,.9), 0 0 40px rgba(229,9,20,0.5);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    .brand span{color:var(--red); text-shadow: 0 0 15px rgba(229,9,20,0.6);}
    .pill{
      border:1px solid rgba(255,255,255,.15);
      background: linear-gradient(135deg, rgba(229,9,20,.15), rgba(34,197,94,.1));
      padding:10px 16px;
      border-radius:999px;
      color:#fff;
      font-size:13px;
      white-space:nowrap;
      font-weight: 600;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }
    .pill:hover{
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(229,9,20,0.3);
    }
    a{color:#fff; text-decoration:none}
    .wrap{
      max-width:1200px; 
      margin:0 auto; 
      padding:32px 18px 56px; 
      position:relative; 
      z-index:1;
      flex: 1;
    }

    .layout{
      display:grid; grid-template-columns: 1.05fr .95fr; gap:20px;
      align-items:start;
    }
    @media (max-width:980px){ .layout{grid-template-columns:1fr;} }

    .card{
      border:1px solid rgba(255,255,255,.12);
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius:24px;
      overflow:hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #e50914, #22c55e, #fbbf24, #e50914);
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
    }
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    .card:hover{
      transform: translateY(-5px);
      box-shadow: 0 25px 70px rgba(229,9,20,.2), 0 10px 40px rgba(0,0,0,.4);
      border-color: rgba(229,9,20,.25);
    }
    
    .head{
      padding:20px 20px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: 
        radial-gradient(500px 200px at 10% 0%, rgba(229,9,20,.25), transparent 70%),
        linear-gradient(180deg, rgba(255,255,255,.08), transparent);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .title{
      font-weight:900; 
      font-size: 20px;
      background: linear-gradient(135deg, #fff 0%, #e50914 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .mini{font-size:13px; color:#9ca3af; line-height: 1.5;}
    .pad{padding:20px}
    
    .countdown{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}
    .cdBox{
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(10,10,10,.6);
      min-width:95px;
      text-align:center;
      transition: all 0.3s ease;
    }
    .cdBox:hover{
      transform: translateY(-3px);
      border-color: rgba(229,9,20,.4);
      box-shadow: 0 8px 20px rgba(229,9,20,.2);
    }
    .cdNum{
      font-size:26px; 
      font-weight:1000; 
      letter-spacing:1px;
      color: #fff;
      text-shadow: 0 0 15px rgba(229,9,20,0.4);
    }
    .cdLbl{font-size:11px; color:var(--muted); text-transform: uppercase; letter-spacing: 1px;}
    
    .note{
      margin-top:16px; 
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(34,197,94,.3);
      background: linear-gradient(135deg, rgba(34,197,94,.15), rgba(34,197,94,.08));
      color:#d1fae5;
      font-size:14px;
      line-height:1.5;
      box-shadow: 0 4px 15px rgba(34,197,94,.1);
    }

    .wheelWrap{
      display:grid; 
      gap:16px; 
      align-items:center; 
      justify-items:center;
      margin-top: 20px;
    }
    canvas{
      width:min(540px, 100%);
      height:auto;
      border-radius:999px;
      background: radial-gradient(circle at 30% 25%, rgba(229,9,20,.15), rgba(0,0,0,.5));
      border:3px solid rgba(229,9,20,.3);
      box-shadow: 
        0 25px 80px rgba(0,0,0,.7),
        0 0 60px rgba(229,9,20,.2),
        inset 0 0 40px rgba(0,0,0,.3);
      transition: all 0.3s ease;
    }
    canvas:hover{
      box-shadow: 
        0 30px 90px rgba(0,0,0,.8),
        0 0 80px rgba(229,9,20,.3),
        inset 0 0 40px rgba(0,0,0,.3);
    }
    
    .pointer{
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-top:26px solid #fff;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.6)) drop-shadow(0 0 12px rgba(229,9,20,.4));
      margin-bottom:-10px;
      animation: pointerBounce 2s ease-in-out infinite;
    }
    @keyframes pointerBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .myTicket{
      margin-top:10px;
      font-size:13px;
      color:#d1d5db;
      padding: 10px 16px;
      background: rgba(34,197,94,.1);
      border: 1px solid rgba(34,197,94,.25);
      border-radius: 12px;
      max-width: 500px;
    }

    .list{
      max-height:540px; 
      overflow:auto; 
      padding-right:8px;
    }
    .list::-webkit-scrollbar{width:8px;}
    .list::-webkit-scrollbar-track{background:rgba(0,0,0,.2);border-radius:10px;}
    .list::-webkit-scrollbar-thumb{background:rgba(229,9,20,.5);border-radius:10px;}
    .list::-webkit-scrollbar-thumb:hover{background:rgba(229,9,20,.7);}
    
    .item{
      display:flex; justify-content:space-between; gap:12px;
      padding:14px 16px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(10,10,10,.5);
      margin:10px 0;
      transition: all 0.3s ease;
      animation: fadeIn 0.4s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .item:hover{
      background: rgba(20,20,20,.7);
      border-color: rgba(229,9,20,.3);
      transform: translateX(8px);
    }
    .me{
      border-color: rgba(229,9,20,.7);
      background: linear-gradient(135deg, rgba(229,9,20,.2), rgba(229,9,20,.1));
      box-shadow: 0 4px 20px rgba(229,9,20,.2);
    }
    .pillMe{
      font-size:11px;
      padding:4px 12px;
      border-radius:999px;
      background: linear-gradient(135deg, #e50914, #c5221f);
      border:1px solid rgba(229,9,20,.5);
      margin-left:10px;
      color:#fff;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(229,9,20,.3);
    }
    
    .btnRow{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px;}
    .btn{
      padding:14px 18px; 
      border-radius:16px; 
      border:0;
      cursor:pointer; 
      font-weight:900;
      font-size: 14px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    .btn span {
      position: relative;
      z-index: 1;
    }
    
    .btnPrimary{
      background: linear-gradient(135deg, #e50914 0%, #c5221f 100%);
      color:#fff;
      box-shadow: 0 8px 25px rgba(229,9,20,.3);
    }
    .btnPrimary:hover{
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(229,9,20,.4);
    }
    .btnPrimary:active{
      transform: translateY(-1px);
    }
    
    .btn:not(.btnPrimary){
      background: rgba(255,255,255,.1);
      color:#fff;
      border:1px solid rgba(255,255,255,.15);
    }
    .btn:not(.btnPrimary):hover{
      background: rgba(255,255,255,.15);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .adminTag{
      font-size:12px;
      padding:6px 14px;
      border-radius:999px;
      border:1px solid rgba(229,9,20,.4);
      background: linear-gradient(135deg, rgba(229,9,20,.25), rgba(229,9,20,.15));
      color:#fff;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(229,9,20,.2);
      animation: pulse 2s ease-in-out infinite;
    }

    footer{
      max-width:1200px; 
      margin:auto auto 0; 
      padding:24px 18px;
      color:rgba(255,255,255,.4); 
      font-size:13px;
      text-align:center;
    }

    /* Decoraci√≥n */
    .tree-left {
      position: fixed;
      bottom: 20px;
      left: 20px;
      font-size: 60px;
      opacity: 0.15;
      z-index: 0;
      animation: sway 4s ease-in-out infinite;
    }
    .tree-right {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 60px;
      opacity: 0.15;
      z-index: 0;
      animation: sway 4s ease-in-out infinite reverse;
    }
    @keyframes sway {
      0%, 100% { transform: rotate(-3deg); }
      50% { transform: rotate(3deg); }
    }
  </style>
</head>

<body>
  <!-- Luces navide√±as -->
  <div class="christmas-lights">
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
    <div class="light"></div>
  </div>

  <div class="snow"></div>
  <div class="tree-left">üéÑ</div>
  <div class="tree-right">üéÅ</div>

  <header>
    <div class="topbar">
      <div class="brand"><div class="dot"></div> SICCHA <span>Streaming</span></div>
      <div class="pill"><a href="index.html">‚Üê Volver al registro</a></div>
    </div>
  </header>

  <main class="wrap">
    <div class="layout">
      <!-- Wheel card -->
      <section class="card">
        <div class="head">
          <div>
            <div class="title">üé° Ruleta navide√±a</div>
            <div class="mini" id="modeLabel">Modo p√∫blico ‚Ä¢ Solo nombres</div>
          </div>
          <div id="adminBadge" class="adminTag" style="display:none;">ADMIN</div>
        </div>

        <div class="pad">
          <div class="countdown">
            <div class="cdBox"><div class="cdNum" id="d">--</div><div class="cdLbl">D√çAS</div></div>
            <div class="cdBox"><div class="cdNum" id="h">--</div><div class="cdLbl">HORAS</div></div>
            <div class="cdBox"><div class="cdNum" id="m">--</div><div class="cdLbl">MIN</div></div>
            <div class="cdBox"><div class="cdNum" id="s">--</div><div class="cdLbl">SEG</div></div>
          </div>

          <div class="note">
            ‚è≥ Resultados: <b>ma√±ana a las 5:00 PM</b>. Contador en retroceso en tiempo real.
          </div>

          <div class="wheelWrap">
            <div class="pointer"></div>
            <canvas id="wheel" width="900" height="900"></canvas>
            <div class="myTicket" id="myTicket"></div>

            <div class="btnRow">
              <button class="btn btnPrimary" id="spinBtn" style="display:none;"><span>üé≤ Girar (solo admin)</span></button>
              <button class="btn" id="refreshBtn"><span>üîÑ Actualizar lista</span></button>
            </div>
            <div class="mini" id="pickMsg" style="margin-top:12px;"></div>
          </div>
        </div>
      </section>

      <!-- List card -->
      <section class="card">
        <div class="head">
          <div>
            <div class="title">üìã Participantes</div>
            <div class="mini" id="count">Cargando...</div>
          </div>
        </div>
        <div class="pad">
          <div class="list" id="list"></div>
          <div class="mini" id="err" style="margin-top:12px;"></div>
        </div>
      </section>
    </div>
  </main>

  <footer>
    SICCHA Streaming ¬© 2025 ‚Ä¢ Sorteo navide√±o promocional
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Crear copos de nieve flotantes
    function createSnowflakes() {
      const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
      for(let i = 0; i < 20; i++) {
        setTimeout(() => {
          const snowflake = document.createElement('div');
          snowflake.className = 'snowflake';
          snowflake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
          snowflake.style.left = Math.random() * 100 + '%';
          snowflake.style.animationDuration = (Math.random() * 4 + 6) + 's';
          snowflake.style.fontSize = (Math.random() * 12 + 16) + 'px';
          snowflake.style.opacity = Math.random() * 0.6 + 0.3;
          document.body.appendChild(snowflake);
          setTimeout(() => snowflake.remove(), 10000);
        }, i * 300);
      }
    }
    createSnowflakes();
    setInterval(createSnowflakes, 6000);

    // Supabase
    const sb = window.supabase.createClient(
      "https://wwfdmvuwjdqzpkeaxgcb.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3ZmRtdnV3amRxenBrZWF4Z2NiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5MzI2NzYsImV4cCI6MjA1MDUwODY3Nn0.tFo5T-sC2sq8D9FgKqJKuQ_MC3en0fl"
    );

    const $ = (id)=>document.getElementById(id);

    // ADMIN por URL: ruleta.html?admin=SICCHA2025
    const ADMIN_CODE = "SICCHA2025";
    const params = new URLSearchParams(location.search);
    const isAdmin = params.get("admin") === ADMIN_CODE;

    if(isAdmin){
      $("spinBtn").style.display = "inline-block";
      $("adminBadge").style.display = "inline-block";
      $("modeLabel").textContent = "Modo admin ‚Ä¢ Puedes girar la ruleta";
    }else{
      $("modeLabel").textContent = "Modo p√∫blico ‚Ä¢ Ruleta solo nombres";
      $("pickMsg").textContent = "üîí El giro est√° desactivado para p√∫blico.";
    }

    function getTarget(){
      const now = new Date();
      const target = new Date(now);
      target.setHours(17, 0, 0, 0);
      return target;
    }
    const target = getTarget();

    function tick(){
      const now = new Date();
      let diff = target - now;
      if(diff <= 0){
        $("d").textContent="0"; $("h").textContent="0"; $("m").textContent="0"; $("s").textContent="0";
        if(isAdmin) $("pickMsg").textContent = "‚úÖ Ya es hora de resultados (5:00 PM).";
        return;
      }
      const sec = Math.floor(diff/1000);
      const days = Math.floor(sec/86400);
      const hrs  = Math.floor((sec%86400)/3600);
      const mins = Math.floor((sec%3600)/60);
      const secs = sec%60;

      $("d").textContent = String(days);
      $("h").textContent = String(hrs).padStart(2,"0");
      $("m").textContent = String(mins).padStart(2,"0");
      $("s").textContent = String(secs).padStart(2,"0");
    }
    setInterval(tick, 1000); tick();

    // Mask name
    function maskName(fullName){
      const parts = fullName.trim().split(/\s+/);
      const first = parts[0] || "";
      const last  = parts[1] || "";
      const initial = last ? (last[0].toUpperCase() + ".") : "";
      return (first + (initial ? (" " + initial) : "")).trim();
    }

    // Load participants
    let participants = [];
    async function loadParticipants(){
      $("err").textContent = "";
      const { data, error } = await sb
        .from("participants")
        .select("name,ticket,created_at")
        .order("created_at", { ascending:false });

      if(error){
        $("err").textContent = "‚ùå Error cargando participantes: " + error.message;
        return;
      }
      participants = data || [];
      renderList();
      drawWheel();
    }

    function renderList(){
      const myTicket = localStorage.getItem("myTicket");
      $("count").textContent = `Total: ${participants.length} participantes`;

      $("list").innerHTML = participants.map(p=>{
        const isMe = myTicket && p.ticket === myTicket;
        return `
          <div class="item ${isMe ? "me" : ""}">
            <div>
              <b>${maskName(p.name)}</b>
              ${isMe ? `<span class="pillMe">T√ö</span>` : ``}
              <div class="mini">${new Date(p.created_at).toLocaleString('es-ES', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}</div>
            </div>
          </div>
        `;
      }).join("") || `<div class="mini">A√∫n no hay participantes.</div>`;

      if(myTicket){
        $("myTicket").textContent = `‚úÖ Tu ticket est√° guardado en este navegador (no se muestra al p√∫blico).`;
      }else{
        $("myTicket").textContent = `üí° Tip: reg√≠strate para que se marque tu nombre como "T√ö".`;
      }
    }

    // Wheel (canvas)
    const canvas = $("wheel");
    const ctx = canvas.getContext("2d");
    let angle = 0;
    let spinning = false;
    let spinVel = 0;

    function drawWheel(){
      const names = participants.map(p => maskName(p.name));
      const n = Math.max(names.length, 1);

      ctx.clearRect(0,0,canvas.width,canvas.height);

      const cx = canvas.width/2, cy = canvas.height/2;
      const radius = canvas.width * 0.44;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      for(let i=0;i<n;i++){
        const start = (i * 2*Math.PI)/n;
        const end   = ((i+1) * 2*Math.PI)/n;

        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,start,end);
        ctx.closePath();
        ctx.fillStyle = (i%2===0) ? "rgba(229,9,20,.9)" : "rgba(34,197,94,.85)";
        ctx.fill();

        ctx.strokeStyle = "rgba(255,255,255,.25)";
        ctx.lineWidth = 3;
        ctx.stroke();

        const mid = (start+end)/2;
        ctx.save();
        ctx.rotate(mid);
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(255,255,255,.98)";
        ctx.font = "bold 28px ui-sans-serif, system-ui";
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 4;
        const label = names[i] || "‚Äî";
        ctx.fillText(label.length>14 ? label.slice(0,14)+"‚Ä¶" : label, radius - 18, 10);
        ctx.restore();
      }

      // center cap
      ctx.beginPath();
      ctx.arc(0,0, radius*0.18, 0, 2*Math.PI);
      ctx.fillStyle = "rgba(0,0,0,.65)";
      ctx.fill();
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(255,255,255,.2)";
      ctx.stroke();

      ctx.shadowColor = "transparent";
      ctx.fillStyle = "rgba(255,255,255,.98)";
      ctx.font = "900 24px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("SICCHA", 0, -6);
      ctx.fillStyle = "rgba(229,9,20,.98)";
      ctx.fillText("Streaming", 0, 22);

      ctx.restore();
    }

    function animate(){
      requestAnimationFrame(animate);

      if(!spinning){
        angle += 0.0012;
        drawWheel();
        return;
      }

      angle += spinVel;
      spinVel *= 0.985;

      if(spinVel < 0.002){
        spinning = false;
        spinVel = 0;

        if(isAdmin){
          const n = Math.max(participants.length, 1);
          const normalized = (2*Math.PI - (angle % (2*Math.PI))) % (2*Math.PI);
          const index = Math.floor((normalized / (2*Math.PI)) * n) % n;
          const picked = participants[index] ? maskName(participants[index].name) : "‚Äî";
          $("pickMsg").textContent = `üéâ Seleccionado (demo): ${picked}`;
        }
      }
      drawWheel();
    }

    $("spinBtn").onclick = ()=>{
      if(!isAdmin) return;
      if(participants.length < 2){
        $("pickMsg").textContent = "Agrega m√°s participantes para que se vea mejor.";
        return;
      }
      if(spinning) return;
      $("pickMsg").textContent = "üé≤ Girando...";
      spinning = true;
      spinVel = 0.35 + Math.random()*0.25;
    };

    $("refreshBtn").onclick = loadParticipants;

    loadParticipants();
    setInterval(loadParticipants, 6000);
    drawWheel();
    animate();
  </script>
</body>
</html>
