<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SICCHA Streaming | Ruleta</title>

  <style>
    :root{
      --bg:#070707;
      --panel: rgba(20,20,20,.78);
      --border: rgba(255,255,255,.10);
      --red:#e50914;
      --muted:#b3b3b3;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --good:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      color:#fff;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(229,9,20,.20), transparent 55%),
        radial-gradient(900px 500px at 85% 0%, rgba(255,255,255,.06), transparent 50%),
        linear-gradient(180deg, #050505, #0b0b0b 40%, #050505);
      overflow-x:hidden;
    }

    /* Snowflakes */
    .snowflake{
      position:fixed;
      top:-40px;
      z-index:0;
      user-select:none;
      pointer-events:none;
      opacity:.65;
      animation-name: fall;
      animation-timing-function: linear;
    }
    @keyframes fall{
      to{ transform: translateY(110vh); }
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.35);
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .topbar{
      max-width:1100px; margin:0 auto; padding:16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.4px;
    }
    .brand .dot{
      width:10px; height:10px; border-radius:999px; background:var(--red);
      box-shadow: 0 0 18px rgba(229,9,20,.8);
    }
    .brand span{color:var(--red)}
    .pill{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding:8px 12px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .wrap{max-width:1100px; margin:0 auto; padding:26px 18px 56px; position:relative; z-index:1;}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:980px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      border:1px solid var(--border);
      background: var(--panel);
      box-shadow: var(--shadow);
      border-radius:22px;
      overflow:hidden;
    }
    .head{
      padding:18px 18px 14px;
      background:
        radial-gradient(600px 220px at 10% 0%, rgba(229,9,20,.20), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    h1{margin:0 0 6px; font-size:24px; line-height:1.1;}
    .sub{margin:0; color:var(--muted); font-size:13px; line-height:1.45;}

    .pad{padding:16px 18px 18px;}
    .mini{font-size:12px; color:var(--muted);}

    /* Countdown */
    .countBox{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      border-radius:18px;
      padding:12px 12px;
      margin-top:10px;
    }
    .clock{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tile{
      min-width:70px;
      padding:10px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      text-align:center;
    }
    .num{font-size:20px; font-weight:1000;}
    .lab{font-size:11px; color:var(--muted); margin-top:2px;}
    .countText{font-size:13px; font-weight:900; margin-top:6px;}

    /* Search + list */
    .tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .tools input, .tools select{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color:#fff;
      outline:none;
    }
    .tools input{flex:1; min-width:220px;}
    .tools select{min-width:190px;}
    .list{
      display:grid;
      gap:10px;
      max-height:420px;
      overflow:auto;
      padding-right:6px;
    }
    .item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      border-radius:18px;
      padding:12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .item.me{
      border-color: rgba(34,197,94,.26);
      background: rgba(34,197,94,.10);
    }
    .pillMe{
      margin-left:10px;
      padding:4px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:900;
      background: rgba(34,197,94,.18);
      border:1px solid rgba(34,197,94,.28);
      color:#d1fae5;
    }

    /* Wheel */
    .canvasWrap{
      display:flex;
      justify-content:center;
      padding:14px 0 8px;
    }
    canvas{
      width:100%;
      max-width:520px;
      aspect-ratio:1/1;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
    }

    .rowBtns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .btn{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.07);
      color:#fff;
      font-weight:1000;
      cursor:pointer;
    }
    .btnPrimary{
      border:0;
      background: linear-gradient(90deg, #ff0a16, #c9000a);
      box-shadow: 0 12px 30px rgba(229,9,20,.22);
    }

    footer{
      max-width:1100px; margin:18px auto 0; padding:0 18px 20px;
      color:rgba(255,255,255,.35); font-size:12px;
      text-align:center;
    }
  </style>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand"><div class="dot"></div> SICCHA <span>Streaming</span></div>
      <div class="pill">üéÑ Ruleta ‚Ä¢ Nombres registrados</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">

      <!-- LEFT: Wheel -->
      <section class="card">
        <div class="head">
          <h1>üé° Ruleta navide√±a</h1>
          <p class="sub">
            La ruleta se llena sola con los nombres registrados. (Solo nombres, sin celulares).
          </p>

          <div class="countBox">
            <div>
              <div style="font-weight:1000;">‚è≥ Cuenta regresiva</div>
              <div class="mini" id="countHint">El sorteo ser√° en unas horas.</div>
              <div class="countText" id="countText"></div>
            </div>
            <div class="clock">
              <div class="tile"><div class="num" id="d">0</div><div class="lab">D√≠as</div></div>
              <div class="tile"><div class="num" id="h">00</div><div class="lab">Horas</div></div>
              <div class="tile"><div class="num" id="m">00</div><div class="lab">Min</div></div>
              <div class="tile"><div class="num" id="s">00</div><div class="lab">Seg</div></div>
            </div>
          </div>
        </div>

        <div class="pad">
          <div class="canvasWrap">
            <canvas id="wheel" width="800" height="800"></canvas>
          </div>

          <div class="rowBtns">
            <button class="btn" onclick="location.href='index.html'">‚¨Ö Volver</button>
            <button class="btn" id="refreshBtn">üîÑ Actualizar nombres</button>
            <button class="btn btnPrimary" onclick="location.href='resultados.html'">üèÜ Ver ganadores</button>
          </div>

          <div class="mini" style="margin-top:10px;">
            Tip: si ya te registraste desde esta misma PC/celular, tu nombre se marcar√° como <b>T√ö</b>.
          </div>

          <div class="mini" id="pickMsg" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- RIGHT: List -->
      <section class="card">
        <div class="head">
          <h1>üë• Nombres registrados</h1>
          <p class="sub" id="count">Total: 0 participantes</p>
          <p class="mini" id="myMark" style="margin-top:6px;"></p>
        </div>

        <div class="pad">
          <div class="tools">
            <input id="searchName" placeholder="üîé Buscar nombre...">
            <select id="sortNames">
              <option value="recent">üïí M√°s recientes</option>
              <option value="az">üî§ A - Z</option>
            </select>
          </div>

          <div class="list" id="list"></div>
          <div class="mini" id="err" style="margin-top:12px;"></div>
        </div>
      </section>

    </div>
  </main>

  <footer>
    SICCHA Streaming ¬© 2025 ‚Ä¢ Sorteo navide√±o promocional
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ‚ùÑÔ∏è Snowflakes floating
    function createSnowflakes() {
      const snowflakes = ['‚ùÑ', '‚ùÖ', '‚ùÜ'];
      for(let i = 0; i < 18; i++) {
        setTimeout(() => {
          const snowflake = document.createElement('div');
          snowflake.className = 'snowflake';
          snowflake.textContent = snowflakes[Math.floor(Math.random() * snowflakes.length)];
          snowflake.style.left = Math.random() * 100 + '%';
          snowflake.style.animationDuration = (Math.random() * 4 + 6) + 's';
          snowflake.style.fontSize = (Math.random() * 12 + 16) + 'px';
          snowflake.style.opacity = Math.random() * 0.6 + 0.3;
          document.body.appendChild(snowflake);
          setTimeout(() => snowflake.remove(), 10000);
        }, i * 260);
      }
    }
    createSnowflakes();
    setInterval(createSnowflakes, 6500);

    // Supabase (publishable)
    const sb = window.supabase.createClient(
      "https://wwfdmvuwjdqzpkeaxgcb.supabase.co",
      "sb_publishable_tFo5T-sC2sq8D9FgKqJKuQ_MC3en0fl"
    );

    const $ = (id)=>document.getElementById(id);

    // ===== COUNTDOWN (HOY 5:00 PM) =====
    function pad2(n){ return String(n).padStart(2, "0"); }
    function getTarget(){
      const now = new Date();
      const t = new Date(now);
      t.setHours(17,0,0,0); // 5:00 PM hoy
      return t;
    }
    function tick(){
      const now = new Date();
      const target = getTarget();
      let diff = target - now;
      if(diff < 0) diff = 0;

      const sec = Math.floor(diff/1000);
      const days = Math.floor(sec/86400);
      const hrs  = Math.floor((sec%86400)/3600);
      const mins = Math.floor((sec%3600)/60);
      const secs = sec%60;

      $("d").textContent = String(days);
      $("h").textContent = pad2(hrs);
      $("m").textContent = pad2(mins);
      $("s").textContent = pad2(secs);

      if(diff > 0){
        $("countHint").textContent = "üéÑ El sorteo ser√° en unas horas.";
        $("countText").textContent = `Faltan ${days} d√≠a(s), ${hrs} hora(s) y ${mins} min para las 5:00 PM.`;
      }else{
        $("countHint").textContent = "üéâ Ya es hora (o ya pas√≥). Revisa Ganadores.";
        $("countText").textContent = "‚úÖ Cuenta regresiva finalizada.";
      }
    }
    setInterval(tick, 1000); tick();

    // Mask name (solo nombre + inicial apellido)
    function maskName(fullName){
      const parts = String(fullName||"").trim().split(/\s+/);
      const first = parts[0] || "";
      const last  = parts[1] || "";
      const initial = last ? (last[0].toUpperCase() + ".") : "";
      return (first + (initial ? (" " + initial) : "")).trim();
    }

    // ===== Load participants (SOLO name,created_at) =====
    let participants = [];
    async function loadParticipants(){
      $("err").textContent = "";

      const { data, error } = await sb
        .from("participants")
        .select("name,created_at")
        .order("created_at", { ascending:false });

      if(error){
        $("err").textContent = "‚ùå Error cargando participantes: " + error.message;
        return;
      }

      participants = data || [];
      renderList();
      drawWheel();
    }

    function renderList(){
      const myName = (localStorage.getItem("myName") || "").trim().toLowerCase();
      const q = ($("searchName").value || "").trim().toLowerCase();
      const sortMode = $("sortNames").value || "recent";

      let listData = [...participants];

      // sort
      if(sortMode === "az"){
        listData.sort((a,b)=> maskName(a.name).localeCompare(maskName(b.name), "es"));
      }else{
        listData.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      }

      // filter
      if(q){
        listData = listData.filter(p => maskName(p.name).toLowerCase().includes(q));
      }

      $("count").textContent = `Total: ${participants.length} participantes ‚Ä¢ Mostrando: ${listData.length}`;

      $("list").innerHTML = listData.map(p=>{
        const show = maskName(p.name);
        const isMe = myName && String(p.name||"").trim().toLowerCase() === myName;

        const stamp = p.created_at ? new Date(p.created_at).toLocaleString("es-PE",{
          day:"numeric", month:"short", year:"numeric", hour:"2-digit", minute:"2-digit"
        }) : "";

        return `
          <div class="item ${isMe ? "me" : ""}">
            <div style="min-width:0;">
              <b>${show}</b>
              ${isMe ? `<span class="pillMe">T√ö</span>` : ``}
              <div class="mini">${stamp}</div>
            </div>
          </div>
        `;
      }).join("") || `<div class="mini">A√∫n no hay participantes.</div>`;

      if(myName){
        $("myMark").textContent = `‚úÖ Este navegador reconoce tu registro: se marcar√° como "T√ö".`;
      }else{
        $("myMark").textContent = `üí° Si te registras, aqu√≠ se marcar√° tu nombre como "T√ö".`;
      }
    }

    $("searchName").addEventListener("input", renderList);
    $("sortNames").addEventListener("change", renderList);
    $("refreshBtn").onclick = loadParticipants;

    // ===== Wheel (canvas) =====
    const canvas = $("wheel");
    const ctx = canvas.getContext("2d");
    let angle = 0;

    function drawWheel(){
      const names = participants.map(p => maskName(p.name));
      const n = Math.max(names.length, 1);

      ctx.clearRect(0,0,canvas.width,canvas.height);

      const cx = canvas.width/2, cy = canvas.height/2;
      const radius = canvas.width * 0.44;

      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);

      for(let i=0;i<n;i++){
        const start = (i * 2*Math.PI)/n;
        const end   = ((i+1) * 2*Math.PI)/n;

        ctx.beginPath();
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius,start,end);
        ctx.closePath();
        ctx.fillStyle = (i%2===0) ? "rgba(229,9,20,.88)" : "rgba(34,197,94,.82)";
        ctx.fill();

        ctx.strokeStyle = "rgba(255,255,255,.22)";
        ctx.lineWidth = 3;
        ctx.stroke();

        const mid = (start+end)/2;
        ctx.save();
        ctx.rotate(mid);
        ctx.textAlign = "right";
        ctx.fillStyle = "rgba(255,255,255,.98)";
        ctx.font = "bold 28px ui-sans-serif, system-ui";
        ctx.shadowColor = "rgba(0,0,0,0.45)";
        ctx.shadowBlur = 4;

        const label = names[i] || "‚Äî";
        ctx.fillText(label.length>14 ? label.slice(0,14)+"‚Ä¶" : label, radius - 18, 10);
        ctx.restore();
      }

      // center cap
      ctx.beginPath();
      ctx.arc(0,0, radius*0.18, 0, 2*Math.PI);
      ctx.fillStyle = "rgba(0,0,0,.60)";
      ctx.fill();
      ctx.lineWidth = 6;
      ctx.strokeStyle = "rgba(255,255,255,.20)";
      ctx.stroke();

      ctx.shadowColor = "transparent";
      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.font = "900 24px ui-sans-serif, system-ui";
      ctx.textAlign = "center";
      ctx.fillText("SICCHA", 0, -6);
      ctx.fillStyle = "rgba(229,9,20,.95)";
      ctx.fillText("Streaming", 0, 22);

      ctx.restore();
    }

    function animate(){
      requestAnimationFrame(animate);
      angle += 0.0012;
      drawWheel();
    }

    loadParticipants();
    setInterval(loadParticipants, 9000);
    drawWheel();
    animate();
  </script>
</body>
</html>
